# Документация для работы с сервисом cyberway.golos_wallet

## Пояснения

Golos_wallet -- сервис, который предоставляет удобный API для взаимодействия с котрактом cyber.token, а именно получать информацию по токенам, трансферам и балансам пользователей cyber.token.

Изначально кошелёк создавался как сервис для биржы Bittrex, который должен был 1 в 1 имитировать cli_wallet. cli_wallet -- консольная утилита для цепочки golos, имеющая возможность взаимодействия с ней через json-rpc интерфейс. Для этого нужно было прописать ключ -r и передать endpoint (пр. 127.0.0.1:2001).

Поэтому у кошелька по сути есть два подмножества методов: унаследованные от cli_wallet и новые, которые упрощаяют работу с cyber.token. Соответственно основное их внешнее различие в нотации:
первые -- `underscore_notation`, вторые -- `smallCamleCase`.

#### Описание механики поддержки актуального состояния балансов пользователей в базе кошелька

**TODO**

#### Формат запросов и ответов

Общение происходит по протоколу [JSON-RPC 2.0](https://www.jsonrpc.org/specification) с некоторыми более строгими
правилами:

-   Параметры запроса должны только быть именованными, в виде JSON-объекта, безымянные не поддерживаются.
-   Результат запроса в поле `result` всегда содержит JSON объект с результатом выполнения.
-   В случае ошибки в поле `error` всегда содержится ответ формата `{"code": 123, "message": "Description text"}`,
    где `code` это цифровой код ошибки, описывающий тип проишествия, а `description` - текстовую ремарку для понимания
    ошибки человеком.
-   RPC-нотификации работают как указано в стандарте, запросы без поля `id` не получают ответа, но сервер может
    их обработать по своему усмотрению.

Дополнительно стоит учитывать что сервер сам может передавать данные на клиент без получения запроса - например
так работает рассылка о событиях для пользователя, данные поступают через WebSocket со стороны сервера и
являются RPC-нотификациями, что не требует от клиента возвращать серверу какой-либо ответ.

## Что использует сервис

-   MongoDB -- база для хранения информации по cyber.token
-   Nats -- очередь, к которой можно подключиться для получения рассылки эвентов от EventEngine.

## Запуск сервиса

#### docker-compose

Для запуска сервиса достаточно вызвать команду `docker-compose up --build` в корне проекта, предварительно указав
необходимые `ENV` переменные.
Это запустит два контейнера: `wallet-mongo` и `wallet-node`.

## Инициализационные параметры

Для запуска сервиса необходимо в корень проекта положить `.env` файл. За основу можно взять `.env.example`.

Основные переменные окружения `ENV`:

-   `GLS_CONNECTOR_HOST` _(обязательно)_ - адрес, который будет использован для входящих подключений связи микросервисов.  
    Дефолтное значение при запуске без докера - `127.0.0.1`

-   `GLS_CONNECTOR_PORT` _(обязательно)_ - адрес порта, который будет использован для входящих подключений связи микросервисов.  
    Дефолтное значение при запуске без докера - `3000`

-   `GLS_METRICS_HOST` - адрес хоста для метрик StatsD.  
    Дефолтное значение при запуске без докера - `127.0.0.1`

-   `GLS_METRICS_PORT` - адрес порта для метрик StatsD.  
    Дефолтное значение при запуске без докера - `8125`

-   `GLS_BLOCKCHAIN_BROADCASTER_CONNECT` _(обязательно)_ - адрес nats для получения эвентов от EventEngine подключенного к ноде cyberway

-   `GLS_MONGO_CONNECT` - строка подключения к базе MongoDB.  
    Дефолтное значение - `mongodb://mongo/admin`

-   `GLS_VERBOSE_LOGS` - включает расширенные логи, по умолчанию выключен.

## API

### getBalance

**Запрос :arrow_right:**

| Процедура  | Авторизация  | Описание                        |
| :--------: | :----------: | ------------------------------- |
| getBalance | Не требуется | Получить баллансы пользователей |

|  Параметр  |   Тип    | Обяз. | Описание                                                             |
| :--------: | :------: | :---: | -------------------------------------------------------------------- |
|   userId   |  string  |  Да   | Имя пользователя                                                     |
| currencies | [string] |  нет  | Массив `sym` интересующих токенов. Указать `["all"]`, если нужны все |
|    type    |  string  |  нет  | Тип токена: `liquid`, `all`                       |

**Пример :one::**

Получаем баланс по всем токенам для пользователя `destroyer`

```json
{
    "id": 1,
    "jsonrpc": "2.0",
    "method": "getBalance",
    "params": {
        "userId": "destroyer"
    }
}
```

**:arrow_left: Ответ**

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "userId": "destroyer",
        "liquid": {
            "balances": {
                "GOLOS": "11.444"
            },
            "payments": {
                "GOLOS": "0.000"
            }
        }
    }
}
```

**Пример :two::**

```json
{
    "id": 1,
    "jsonrpc": "2.0",
    "method": "getBalance",
    "params": {
        "userId": "cyber.token",
        "currencies": ["ABCXXXX", "ABXXXXX"],
        "type": "liquid"
    }
}
```

**:arrow_left: Ответ**

```json
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": {
        "userId": "cyber.token",
        "liquid": {
            "balances": {
                "ABCXXXX": "10.000",
                "ABXXXXX": "11.000"
            },
            "payments": {
                "ABCXXXX": "11.000",
                "ABXXXXX": "1.000"
            }
        }
    }
}
```

---

### getTransferHistory

**Запрос :arrow_right:**

|     Процедура      | Авторизация  | Описание                                  |
| :----------------: | :----------: | ----------------------------------------- |
| getTransferHistory | Не требуется | Получить историю трансферов пользователей |

|  Параметр   |        Тип         | Обяз. | Описание                                                                                                                                                                             |
| :---------: | :----------------: | :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|   userId    |      `string`      |  Да   | Имя пользователя                                                                                                                                                                     |
|  direction  |      `string`      |  Нет  | Направление: `in`, `out`, `all`                                                                                                                                                      |
| sequenceKey | `null` or `string` |  Да   | Отступ от начала списка. Если передана строка с валидным sequenceKey, то будет возвращено не более `limit` элементов начиная со следующего за элементом с `_id` равным `sequenceKey` |
|    limit    |      `number`      |  Да   | Количество записей из списка трансферов. В паре с `sequenceKey` формирует отрезок запроса: `[begin, from]` размером `limit`. Не может быть больше `from`, если `from > -1`           |

#### Необходимо указать отправителя и получателя. Для работы необходим хотя бы один из них.

Пример:

Получаем все транзакции с отправителем или получателем `tst2kpdqxjla`

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "getTransferHistory",
    "params": {
        "userId": "tst2kpdqxjla",
        "limit": 100
    }
}
```

**:arrow_left: Ответ**

Если трансферы соответствующие запросу существуют, то будет возващён массив объектов `TransferModel`, иначе пустой массив.

```json
{
    "jsonrpc": "2.0",
    "id": 131542,
    "result": {
        "items": [
            {
                "id": "5d069a3e2b07cc09f1556d94",
                "sender": "tst2kpdqxjla",
                "receiver": "tst3ekvfbcra",
                "quantity": "0.001 GOLOS",
                "sym": "GOLOS",
                "trxId": "3e43c4411e1ef5638c5b477ec52b4a11de582218e491f0d9ef4f0b878455b3d6",
                "memo": "memo",
                "blockNum": 148764,
                "timestamp": "2019-06-16T19:36:24.000Z"
            },
            {
                "id": "5d069a202b07cc4c88556d73",
                "sender": "tst2kpdqxjla",
                "receiver": "gls.vesting",
                "quantity": "1.000 GOLOS",
                "sym": "GOLOS",
                "trxId": "f481be42e6c227667f6d96d9acbe18f68dd05fd5ce063d05b4fa9355de3c8267",
                "memo": "",
                "blockNum": 148754,
                "timestamp": "2019-06-16T19:35:54.000Z"
            }
        ],
        "sequenceKey": "5d069a202b07cc4c88556d73"
    }
}
```

---

### getTokensInfo

**Запрос :arrow_right:**

|   Процедура   | Авторизация  | Описание                                            |
| :-----------: | :----------: | --------------------------------------------------- |
| getTokensInfo | Не требуется | Получить информацию по токенам хранящимся в системе |

| Параметр |   Тип    | Обяз. | Описание                                |
| :------: | :------: | :---: | --------------------------------------- |
|  tokens  | string[] |  Да   | Массив строк `sym` интересующих токенов |

Пример:

Получим информацию по некоторым токенам:

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "getTokensInfo",
    "params": {
        "tokens": ["REACT", "NEST", "ANGULAR", "CXX"]
    }
}
```

**:arrow_left: Ответ**

Будет возвращён массив с информацией по запрашиваемым токенам, которые были найдены в базе. Если на входе в массиве были токены, которых нет в базе, то для них будет отсутствовать запись в возвращаемом результате.

```json
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": {
        "tokens": [
            {
                "issuer": "cyber.token",
                "max_supply": "10000000000.0000 REACT",
                "supply": "10000000000.0000 REACT",
                "sym": "REACT"
            },
            {
                "issuer": "cyber.token",
                "max_supply": "10000000000.0000 NEST",
                "supply": "10000000000.0000 NEST",
                "sym": "NEST"
            },
            {
                "issuer": "cyber.token",
                "max_supply": "10000000000.0000 ANGULAR",
                "supply": "10000000000.0000 ANGULAR",
                "sym": "ANGULAR"
            },
            {
                "issuer": "cyber.token",
                "max_supply": "10000000000.0000 CXX",
                "supply": "10000000000.0000 CXX",
                "sym": "CXX"
            }
        ]
    }
}
```

**:x: Ошибки**

| error code |     message     | Описание                      |
| :--------: | :-------------: | ----------------------------- |
|    805     | Wrong arguments | Передан некорректный аргумент |

---

### filter_account_history

**Запрос :arrow_right:**

|       Процедура        | Авторизация  | Описание                                                                                                      |
| :--------------------: | :----------: | ------------------------------------------------------------------------------------------------------------- |
| filter_account_history | Не требуется | Получить историю трансферов пользователя. Отличается от `getHistory` настройкой фильтров (как в `cli_wallet`) |

| Параметр |  Тип   | Обяз. | Описание                                                                                                                                                             |
| :------: | :----: | :---: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| account  | string |  Да   | Имя пользователя                                                                                                                                                     |
|   from   | number |  Да   | Размер отступа от начала списка трансферов в базе. Значение `-1` указывает на конец списка                                                                           |
|  limit   | number |  Да   | Количество записей из списка трансферов. В паре с `limit` формирует отрезок запроса: `[begin, from]` размером `limit`. Не может быть больше `from`, если `from > -1` |
|  query   | object |  Да   | Фильтр для запросов. Обязательно должен быть указан хотя бы один параметр                                                                                            |

#### Параметры query

|      Параметр      |  Тип   | Обяз. | Описание                                                              |
| :----------------: | :----: | :---: | --------------------------------------------------------------------- |
|     select_ops     | object |  Нет  | **Не реализовано**                                                    |
|     filter_ops     | object |  Нет  | **Не реализовано**                                                    |
|     direction      | object |  Нет  | Указывает роль `account` в трансфере                                  |
|  direction.sender  | object |  Нет  | Фильтрует только те трансферы, где отправитель `account`              |
| direction.receiver | object |  Нет  | Фильтрует только те трансферы, где получатель `account`               |
|   direction.dual   | object |  Нет  | Фильтрует только те трансферы, где отправитель и получатель `account` |
|  direction === {}  | object |  Нет  | Позволяет получить все трансферы, где фигурирует `account`            |

Пример:

Получаем все транзакции с отправителем `cyber.token`

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "filter_account_history",
    "params": ["cyber.token", -1, 100, {}]
}
```

**Или**

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "filter_account_history",
    "params": {
        "account": "cyber.token",
        "from": -1,
        "limit": 100,
        "query": {}
    }
}
```

**:arrow_left: Ответ**

Если трансферы соответствующие запросу существуют, то будет возващён массив объектов `TransferModel`, иначе пустой массив.

```json
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": [
        [
            0,
            {
                "blockNum": 905226,
                "op": [
                    "transfer",
                    {
                        "amount": "1.0000 GLS",
                        "from": "cyber.token",
                        "memo": "{}",
                        "to": "korpusenko"
                    }
                ],
                "timestamp": "2019-04-01T18:34:27.000",
                "trxId": "551fd2f848bc32ee256c2880b2186b5307908448f37ca7850e09ef46142f5b9b"
            }
        ],
        [
            1,
            {
                "blockNum": 905227,
                "op": [
                    "transfer",
                    {
                        "amount": "2.0000 GLS",
                        "from": "cyber.token",
                        "memo": "{}",
                        "to": "korpusenko"
                    }
                ],
                "timestamp": "2019-04-01T18:34:30.000",
                "trxId": "6619198ac252582755e641a743a1fe7663ec28b726180f21c50e1d4dd62af737"
            }
        ]
    ]
}
```

**:x: Ошибки**

| error code |     message     | Описание                        |
| :--------: | :-------------: | ------------------------------- |
|    805     | Wrong arguments | Переданы некорректные параметры |

---

### getClaimHistory

**Запрос :arrow_right:**

|    Процедура    | Авторизация  | Описание                                                                   |
| :-------------: | :----------: | -------------------------------------------------------------------------- |
| getClaimHistory | Не требуется | Получить историю наград пользователя. Использует механику `from` - `limit` |

|  Параметр   |   Тип    | Обяз. | Описание                                                                                                                                                                             |
| :---------: | :------: | :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|   userId    |  string  |  Да   | Имя пользователя                                                                                                                                                                     |
| sequenceKey |  string  |  Нет  | Отступ от начала списка. Если передана строка с валидным sequenceKey, то будет возвращено не более `limit` элементов начиная со следующего за элементом с `_id` равным `sequenceKey` |
|   tokens    | [string] |  Нет  | Названия токенов. `['all']` - по умолчанию                                                                                                                                           |
|    limit    |  number  |  Нет  | Количество записей из списка трансферов. В паре с `limit` формирует отрезок запроса: `[begin, from]` размером `limit`. Не может быть больше `from`, если `from > -1`                 |

Пример:

Получим историю клеймов `testuser`:

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "getClaimHistory",
    "params": {
        "userId": "la3jqfmtkgms",
        "limit": 2
    }
}
```

**:arrow_left: Ответ**

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "claims": [
            {
                "id": "5d274cb3eef0a2d1c5e7bcfa",
                "userId": "la3jqfmtkgms",
                "blockNum": 31832,
                "trxId": "d260f20ac581ab105b5ae3c9a00d3a7d46a53347c778bf044ccf9d567033d1c1",
                "timestamp": "2019-07-11T14:50:21.000Z",
                "sym": "GOLOS",
                "quantity": "0.123"
            },
            {
                "id": "5d274cb3eef0a2962fe7bcfc",
                "userId": "la3jqfmtkgms",
                "blockNum": 31832,
                "trxId": "d260f20ac581ab105b5ae3c9a00d3a7d46a53347c778bf044ccf9d567033d1c1",
                "timestamp": "2019-07-11T14:50:21.000Z",
                "sym": "GOLOS",
                "quantity": "2.390"
            }
        ],
        "sequenceKey": "5d274cb3eef0a2962fe7bcfc"
    }
}
```

---
